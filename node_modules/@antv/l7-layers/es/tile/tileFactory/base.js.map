{"version":3,"sources":["../../../src/tile/tileFactory/base.ts"],"names":["Source","osmLonLat2TileXY","MaskLayer","getLayerShape","readRasterValue","registerLayers","VectorLayer","turf","union","TileFactory","option","click","mousemove","mouseup","mousedown","contextmenu","parentLayer","parent","mapService","rendererService","source","getSource","zoomOffset","parser","tilesetManager","tileset","tile","initOptions","layers","layerIDList","emptyData","features","featureId","vectorTileLayer","sourceLayer","data","Array","isArray","length","type","tileLayerOption","L7Layer","mask","color","layerType","size","shape","FactoryTileLayer","layer","visible","isVisible","tileOrigin","l7TileOrigin","coord","l7TileCoord","getLayerInitOption","isVector","emitEvent","select","setScale","setStyleAttributeField","masklayer","bboxPolygon","push","addMaskLayer","styles","value","defaultValue","getDefautStyleAttributeField","params","parseScaleValue","field","values","callback","lng","lat","zoom","getZoom","z","Math","ceil","xy","tiles","filter","t","key","map","once","on","e","eventCache","lngLat","getTile","getFeatureAndEmitEvent","handleOutsideEvent","p","properties","feature","polygon","coordinates","eventName","x","y","getAllFeatures","getCombineFeature","err","console","warn","emit","scaleOptions","tileLayer","scaleField","scaleKeys","Object","keys","scale","allLayers","children","dataArray","_id","coords","emitType","outSideEventTimer","clearTimeout","setTimeout"],"mappings":"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","sourcesContent":["import {\n  ILayer,\n  IMapService,\n  IParseDataItem,\n  IRendererService,\n  IScaleValue,\n  ISubLayerInitOptions,\n  ScaleAttributeType,\n} from '@antv/l7-core';\nimport Source from '@antv/l7-source';\nimport { osmLonLat2TileXY, Tile, TilesetManager } from '@antv/l7-utils';\nimport MaskLayer from '../../mask';\nimport {\n  getLayerShape,\n  readPixel,\n  readRasterValue,\n  registerLayers,\n} from '../utils';\nimport VectorLayer from './vectorLayer';\n\nimport * as turf from '@turf/helpers';\nimport union from '@turf/union';\nimport {\n  CacheEvent,\n  ILayerTileConfig,\n  ITileFactory,\n  ITileFactoryOptions,\n  ITileStyles,\n  Timeout,\n} from '../interface';\n\nexport default class TileFactory implements ITileFactory {\n  public type: string;\n  public parentLayer: ILayer;\n  public mapService: IMapService;\n  public rendererService: IRendererService;\n  public outSideEventTimer: Timeout | null = null;\n  protected zoomOffset: number;\n  protected tilesetManager: TilesetManager;\n  protected layers: ILayer[];\n  // 用于记录图层内事件，辅助判断图层外事件逻辑\n  private eventCache = {\n    click: 0,\n    mousemove: 0,\n    mouseup: 0,\n    mousedown: 0,\n    contextmenu: 0,\n  };\n  constructor(option: ITileFactoryOptions) {\n    this.parentLayer = option.parent;\n    this.mapService = option.mapService;\n    this.rendererService = option.rendererService;\n\n    const source = this.parentLayer.getSource();\n    this.zoomOffset = source.parser.zoomOffset || 0;\n    this.tilesetManager = source.tileset as TilesetManager;\n  }\n\n  public createTile(tile: Tile, initOptions: ISubLayerInitOptions) {\n    return {\n      layers: [] as ILayer[],\n      layerIDList: [] as string[],\n    };\n  }\n\n  public getFeatureData(tile: Tile, initOptions: ISubLayerInitOptions) {\n    const emptyData = {\n      features: [],\n      featureId: null,\n      vectorTileLayer: null,\n      source: null,\n    };\n    const { sourceLayer, featureId } = initOptions;\n    if (!sourceLayer) {\n      return emptyData;\n    }\n    const vectorTileLayer = tile.data.layers[sourceLayer];\n    const features = vectorTileLayer?.features;\n    if (!(Array.isArray(features) && features.length > 0)) {\n      return emptyData;\n    } else {\n      const source = new Source(\n        {\n          type: 'FeatureCollection',\n          features,\n        },\n        {\n          parser: {\n            type: 'geojson',\n            featureId,\n          },\n        },\n      );\n\n      return {\n        features,\n        featureId,\n        vectorTileLayer,\n        source,\n      };\n    }\n  }\n\n  public createLayer(tileLayerOption: ILayerTileConfig) {\n    const {\n      L7Layer,\n      tile,\n      initOptions,\n      vectorTileLayer,\n      source,\n    } = tileLayerOption;\n    const { mask, color, layerType, size, shape } = initOptions;\n    const FactoryTileLayer = L7Layer ? L7Layer : VectorLayer;\n    const layer = new FactoryTileLayer({\n      visible: tile.isVisible,\n      tileOrigin: vectorTileLayer?.l7TileOrigin,\n      coord: vectorTileLayer?.l7TileCoord,\n      ...this.getLayerInitOption(initOptions),\n    });\n    // vector layer set config\n    if (layer.isVector) {\n      this.emitEvent([layer]);\n      layer.type = layerType;\n      layer.select(true);\n    }\n\n    // set source\n    layer.source(source);\n\n    // set scale\n    this.setScale(layer);\n    // console.log(this.parentLayer.getScaleOptions())\n    // console.log()\n\n    // console.log(this.parentLayer.tileLayer.scaleCfg)\n\n    // set scale attribute field\n    this.setStyleAttributeField(layer, 'shape', shape);\n    this.setStyleAttributeField(layer, 'color', color);\n    this.setStyleAttributeField(layer, 'size', size);\n\n    // set mask\n    const layers = [layer];\n    if (mask && layer.isVector) {\n      const masklayer = new MaskLayer()\n        .source({\n          type: 'FeatureCollection',\n          features: [tile.bboxPolygon],\n        })\n        .shape('fill');\n\n      layers.push(masklayer as VectorLayer);\n\n      layer.addMaskLayer(masklayer);\n    }\n    // regist layer\n    registerLayers(this.parentLayer, layers);\n\n    this.layers = [layer];\n\n    return layer;\n  }\n\n  public updateStyle(styles: ITileStyles) {\n    return '';\n  }\n\n  public getDefautStyleAttributeField(layer: ILayer, type: string) {\n    switch (type) {\n      case 'size':\n        return 2;\n      case 'color':\n        return '#fff';\n      case 'shape':\n        return getLayerShape(this.parentLayer.type, layer);\n      default:\n        return '';\n    }\n  }\n\n  public setStyleAttributeField(\n    layer: ILayer,\n    type: ScaleAttributeType,\n    value: IScaleValue | undefined | string | string[],\n  ) {\n    if (Array.isArray(value)) {\n      // @ts-ignore\n      layer[type](...value);\n      return;\n    }\n    if (typeof value === 'string') {\n      layer[type](value);\n      return;\n    }\n    const defaultValue = this.getDefautStyleAttributeField(layer, type);\n    if (!value) {\n      layer[type](defaultValue);\n      return layer;\n    }\n    const params = this.parseScaleValue(value, type);\n    if (params.length === 0) {\n      layer[type](defaultValue);\n    } else {\n      // @ts-ignore\n      layer[type](...params);\n    }\n  }\n\n  protected parseScaleValue(value: IScaleValue | string, type: string) {\n    if (type === 'shape') {\n      if (typeof value === 'string') {\n        return [value];\n      } else if (value?.field) {\n        return [value?.field];\n      } else {\n        return [];\n      }\n    }\n    const { field, values, callback } = value as IScaleValue;\n    if (field && values && Array.isArray(values)) {\n      return [field, values];\n    } else if (field && callback) {\n      return [field, callback];\n    } else if (field) {\n      return [field];\n    }\n    return [];\n  }\n\n  protected getTile(lng: number, lat: number) {\n    const zoom = this.mapService.getZoom();\n    const z = Math.ceil(zoom) + this.zoomOffset;\n    const xy = osmLonLat2TileXY(lng, lat, z);\n\n    const tiles = this.tilesetManager.tiles.filter(\n      (t) => t.key === `${xy[0]},${xy[1]},${z}`,\n    );\n    const tile = tiles[0];\n    return tile;\n  }\n\n  protected emitEvent(layers: ILayer[], isVector?: boolean) {\n    layers.map((layer) => {\n      layer.once('inited', () => {\n        layer.on('click', (e) => {\n          this.eventCache.click = 1;\n          if (this.parentLayer.type === 'RasterLayer') {\n            const { lng, lat } = e.lngLat;\n            const tile = this.getTile(lng, lat);\n            this.getFeatureAndEmitEvent(\n              layer,\n              'subLayerClick',\n              e,\n              isVector,\n              tile,\n            );\n          } else {\n            this.getFeatureAndEmitEvent(layer, 'subLayerClick', e);\n          }\n        });\n\n        layer.on('mousemove', (e) => {\n          this.eventCache.mousemove = 1;\n          if (this.parentLayer.type === 'RasterLayer') {\n            const { lng, lat } = e.lngLat;\n            const tile = this.getTile(lng, lat);\n            this.getFeatureAndEmitEvent(\n              layer,\n              'subLayerMouseMove',\n              e,\n              isVector,\n              tile,\n            );\n          } else {\n            this.getFeatureAndEmitEvent(layer, 'subLayerMouseMove', e);\n          }\n        });\n        layer.on('mouseup', (e) => {\n          this.eventCache.mouseup = 1;\n          this.getFeatureAndEmitEvent(layer, 'subLayerMouseUp', e);\n        });\n        layer.on('mouseenter', (e) => {\n          if (this.parentLayer.type === 'RasterLayer') {\n            const { lng, lat } = e.lngLat;\n            const tile = this.getTile(lng, lat);\n            this.getFeatureAndEmitEvent(\n              layer,\n              'subLayerMouseMove',\n              e,\n              isVector,\n              tile,\n            );\n          } else {\n            this.getFeatureAndEmitEvent(layer, 'subLayerMouseEnter', e);\n          }\n        });\n        layer.on('mouseout', (e) => {\n          this.getFeatureAndEmitEvent(layer, 'subLayerMouseOut', e);\n        });\n        layer.on('mousedown', (e) => {\n          this.eventCache.mousedown = 1;\n          this.getFeatureAndEmitEvent(layer, 'subLayerMouseDown', e);\n        });\n        layer.on('contextmenu', (e) => {\n          this.eventCache.contextmenu = 1;\n          this.getFeatureAndEmitEvent(layer, 'subLayerContextmenu', e);\n        });\n\n        // out side\n        layer.on('unclick', (e) =>\n          this.handleOutsideEvent('click', 'subLayerUnClick', layer, e),\n        );\n        layer.on('unmouseup', (e) =>\n          this.handleOutsideEvent('mouseup', 'subLayerUnMouseUp', layer, e),\n        );\n        layer.on('unmousedown', (e) =>\n          this.handleOutsideEvent('mousedown', 'subLayerUnMouseDown', layer, e),\n        );\n        layer.on('uncontextmenu', (e) =>\n          this.handleOutsideEvent(\n            'contextmenu',\n            'subLayerUnContextmenu',\n            layer,\n            e,\n          ),\n        );\n      });\n    });\n  }\n\n  protected getCombineFeature(features: IParseDataItem[]) {\n    let p: any = null;\n    const properties = features[0];\n    features.map((feature) => {\n      const polygon = turf.polygon(feature.coordinates);\n      if (p === null) {\n        p = polygon;\n      }\n      {\n        p = union(p, polygon);\n      }\n    });\n    if (properties) {\n      p.properties = { ...properties };\n    }\n    return p;\n  }\n\n  protected getFeatureAndEmitEvent(\n    layer: ILayer,\n    eventName: string,\n    e: any,\n    isVector?: boolean,\n    tile?: any,\n  ) {\n    if (isVector === false) {\n      // raster tile get rgb\n      // e.pickedColors = readPixel(e.x, e.y, this.rendererService);\n      // raster tile origin value\n      e.value = readRasterValue(tile, this.mapService, e.x, e.y);\n    } else {\n      // VectorLayer\n      const featureId = e.featureId;\n      const features = this.getAllFeatures(featureId);\n      try {\n        e.feature = this.getCombineFeature(features);\n      } catch (err) {\n        console.warn('Combine Featuer Err! Return First Feature!');\n        e.feature = features[0];\n      }\n    }\n    this.parentLayer.emit(eventName, e);\n  }\n\n  private setScale(layer: ILayer) {\n    const scaleOptions = this.parentLayer.tileLayer.scaleField;\n    const scaleKeys = Object.keys(scaleOptions);\n    scaleKeys.map((key) => {\n      layer.scale(key, scaleOptions[key]);\n    });\n  }\n\n  private getAllFeatures(featureId: number) {\n    const allLayers: ILayer[] = this.parentLayer.tileLayer.children;\n    const features: IParseDataItem[] = [];\n    allLayers.map((layer) => {\n      const source = layer.getSource();\n      source.data.dataArray.map((feature) => {\n        if (feature._id === featureId) {\n          features.push(feature);\n        }\n      });\n    });\n    return features;\n  }\n\n  private getLayerInitOption(initOptions: ISubLayerInitOptions) {\n    const option = { ...initOptions };\n    delete option.color;\n    delete option.shape;\n    delete option.size;\n    delete option.coords;\n    delete option.sourceLayer;\n    delete option.coords;\n    return option;\n  }\n\n  private handleOutsideEvent(\n    type: CacheEvent,\n    emitType: string,\n    layer: ILayer,\n    e: any,\n  ) {\n    if (this.outSideEventTimer) {\n      clearTimeout(this.outSideEventTimer);\n      this.outSideEventTimer = null;\n    }\n    this.outSideEventTimer = setTimeout(() => {\n      if (this.eventCache[type] > 0) {\n        this.eventCache[type] = 0;\n      } else {\n        this.getFeatureAndEmitEvent(layer, emitType, e);\n      }\n    }, 64);\n  }\n}\n"],"file":"base.js"}