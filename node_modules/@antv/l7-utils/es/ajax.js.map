{"version":3,"sources":["../src/ajax.ts"],"names":["getReferrer","$window","$XMLHttpRequest","AJAXError","status","statusText","url","body","Error","makeFetchRequest","requestParameters","callback","request","Request","method","credentials","headers","referrer","signal","type","set","fetch","then","response","ok","arrayBuffer","json","text","result","get","catch","err","message","blob","error","makeXMLHttpRequest","xhr","open","responseType","k","hasOwnProperty","setRequestHeader","withCredentials","onerror","onload","data","JSON","parse","getResponseHeader","Blob","send","makeRequest","getJSON","getArrayBuffer","postData","sameOrigin","a","document","createElement","href","protocol","location","host","transparentPngUrl","arrayBufferToImage","img","Image","URL","webkitURL","crossOrigin","revokeObjectURL","src","window","requestAnimationFrame","Uint8Array","byteLength","createObjectURL","arrayBufferToImageBitmap","createImageBitmap","imgBitmap","e","getImage","imgData","imageBitmapSupported","arrayBufferToTiffImage","rasterParser","rasterData","width","height","defaultMIN","defaultMAX","min","max","getTiffImage"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport * as GeoTIFF from 'geotiff';\nimport { getReferrer } from './env';\nimport { $window, $XMLHttpRequest } from './mini-adapter';\n\nexport type RequestParameters = {\n  url: string;\n  headers?: any;\n  method?: 'GET' | 'POST' | 'PUT';\n  body?: string;\n  type?: 'string' | 'json' | 'arrayBuffer';\n  credentials?: 'same-origin' | 'include';\n  collectResourceTiming?: boolean;\n  signal?: AbortSignal;\n};\n\nexport type ResponseCallback<T> = (\n  error?: Error | null,\n  data?: T | null,\n  cacheControl?: string | null,\n  expires?: string | null,\n) => void;\n\nexport class AJAXError extends Error {\n  /**\n   * The response's HTTP status code.\n   */\n  public status: number;\n\n  /**\n   * The response's HTTP status text.\n   */\n  public statusText: string;\n\n  /**\n   * The request's URL.\n   */\n  public url: string;\n\n  /**\n   * The response's body.\n   */\n  public body: Blob;\n\n  constructor(status: number, statusText: string, url: string, body: Blob) {\n    super(`AJAXError: ${statusText} (${status}): ${url}`);\n    this.status = status;\n    this.statusText = statusText;\n    this.url = url;\n    this.body = body;\n  }\n}\n\nfunction makeFetchRequest(\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<any>,\n) {\n  const request = new Request(requestParameters.url, {\n    method: requestParameters.method || 'GET',\n    body: requestParameters.body,\n    credentials: requestParameters.credentials,\n    headers: requestParameters.headers,\n    referrer: getReferrer(),\n    signal: requestParameters?.signal,\n  });\n\n  if (requestParameters.type === 'json') {\n    request.headers.set('Accept', 'application/json');\n  }\n\n  return fetch(request)\n    .then((response) => {\n      if (response.ok) {\n        return (requestParameters.type === 'arrayBuffer'\n          ? response.arrayBuffer()\n          : requestParameters.type === 'json'\n          ? response.json()\n          : response.text()\n        )\n          .then((result) => {\n            callback(\n              null,\n              result,\n              response.headers.get('Cache-Control'),\n              response.headers.get('Expires'),\n            );\n          })\n          .catch((err) => {\n            callback(new Error(err.message));\n          });\n      }\n      return response\n        .blob()\n        .then((body) =>\n          callback(\n            new AJAXError(\n              response.status,\n              response.statusText,\n              requestParameters.url,\n              body,\n            ),\n          ),\n        );\n    })\n    .catch((error) => {\n      callback(new Error(error.message));\n    });\n}\n\nfunction makeXMLHttpRequest(\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<any>,\n) {\n  const xhr = new $XMLHttpRequest();\n\n  xhr.open(requestParameters.method || 'GET', requestParameters.url, true);\n  if (requestParameters.type === 'arrayBuffer') {\n    xhr.responseType = 'arraybuffer';\n  }\n  for (const k in requestParameters.headers) {\n    if (requestParameters.headers.hasOwnProperty(k)) {\n      xhr.setRequestHeader(k, requestParameters.headers[k]);\n    }\n  }\n  if (requestParameters.type === 'json') {\n    xhr.responseType = 'text';\n    xhr.setRequestHeader('Accept', 'application/json');\n  }\n  xhr.withCredentials = requestParameters.credentials === 'include';\n  xhr.onerror = () => {\n    callback(new Error(xhr.statusText));\n  };\n  xhr.onload = () => {\n    if (\n      ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 0) &&\n      xhr.response !== null\n    ) {\n      let data: unknown = xhr.response;\n      if (requestParameters.type === 'json') {\n        // We're manually parsing JSON here to get better error messages.\n        try {\n          data = JSON.parse(xhr.response);\n        } catch (err) {\n          return callback(err as Error);\n        }\n      }\n      callback(\n        null,\n        data,\n        xhr.getResponseHeader('Cache-Control'),\n        xhr.getResponseHeader('Expires'),\n      );\n    } else {\n      const body = new Blob([xhr.response], {\n        type: xhr.getResponseHeader('Content-Type'),\n      });\n      callback(\n        new AJAXError(xhr.status, xhr.statusText, requestParameters.url, body),\n      );\n    }\n  };\n  xhr.send(requestParameters.body);\n\n  return xhr;\n}\n\nfunction makeRequest(\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<any>,\n) {\n  // TODO: isWorker\n  // makeFetchRequest\n\n  return makeXMLHttpRequest(requestParameters, callback);\n}\n\nexport const getJSON = (\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<any>,\n) => {\n  return makeRequest({ ...requestParameters, type: 'json' }, callback);\n};\n\nexport const getArrayBuffer = (\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<ArrayBuffer>,\n) => {\n  return makeRequest({ ...requestParameters, type: 'arrayBuffer' }, callback);\n};\n\nexport const postData = (\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<string>,\n) => {\n  return makeRequest({ ...requestParameters, method: 'POST' }, callback);\n};\n\nfunction sameOrigin(url: string) {\n  const a = $window.document.createElement('a');\n  a.href = url;\n  return (\n    a.protocol === $window.document.location.protocol &&\n    a.host === $window.document.location.host\n  );\n}\n\nconst transparentPngUrl =\n  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=';\n\nfunction arrayBufferToImage(\n  data: ArrayBuffer,\n  callback: (err?: Error | null, image?: HTMLImageElement | null) => void,\n) {\n  const img: HTMLImageElement = new $window.Image();\n  const URL = $window.URL || $window.webkitURL;\n  img.crossOrigin = 'anonymous';\n  img.onload = () => {\n    callback(null, img);\n    URL.revokeObjectURL(img.src);\n    // prevent image dataURI memory leak in Safari;\n    // but don't free the image immediately because it might be uploaded in the next frame\n    // https://github.com/mapbox/mapbox-gl-js/issues/10226\n    img.onload = null;\n    window.requestAnimationFrame(() => {\n      img.src = transparentPngUrl;\n    });\n  };\n  img.onerror = () =>\n    callback(\n      new Error(\n        'Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.',\n      ),\n    );\n  const blob: Blob = new Blob([new Uint8Array(data)], { type: 'image/png' });\n  img.src = data.byteLength ? URL.createObjectURL(blob) : transparentPngUrl;\n}\n\nfunction arrayBufferToImageBitmap(\n  data: ArrayBuffer,\n  callback: (err?: Error | null, image?: ImageBitmap | null) => void,\n) {\n  const blob: Blob = new Blob([new Uint8Array(data)], { type: 'image/png' });\n  createImageBitmap(blob)\n    .then((imgBitmap) => {\n      callback(null, imgBitmap);\n    })\n    .catch((e) => {\n      callback(\n        new Error(\n          `Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`,\n        ),\n      );\n    });\n}\n\nexport const getImage = (\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<HTMLImageElement | ImageBitmap | null>,\n) => {\n  // request the image with XHR to work around caching issues\n  // see https://github.com/mapbox/mapbox-gl-js/issues/1470\n  return getArrayBuffer(requestParameters, (err, imgData) => {\n    if (err) {\n      callback(err);\n    } else if (imgData) {\n      const imageBitmapSupported = typeof createImageBitmap === 'function';\n      if (imageBitmapSupported) {\n        arrayBufferToImageBitmap(imgData, callback);\n      } else {\n        arrayBufferToImage(imgData, callback);\n      }\n    }\n  });\n};\n\nconst arrayBufferToTiffImage = async (\n  data: ArrayBuffer,\n  callback: (err?: Error | null, image?: any) => void,\n  rasterParser: any,\n) => {\n  try {\n    const { rasterData, width, height } = await rasterParser(data);\n    const defaultMIN = 0;\n    const defaultMAX = 8000;\n    callback(null, {\n      data: rasterData,\n      width,\n      height,\n      min: defaultMIN,\n      max: defaultMAX,\n    });\n  } catch (err) {\n    callback(null, new Error('' + err));\n  }\n};\n\nexport const getTiffImage = (\n  requestParameters: RequestParameters,\n  callback: ResponseCallback<HTMLImageElement | ImageBitmap | null>,\n  rasterParser: any,\n) => {\n  return getArrayBuffer(requestParameters, (err, imgData) => {\n    if (err) {\n      callback(err);\n    } else if (imgData) {\n      arrayBufferToTiffImage(imgData, callback, rasterParser);\n    }\n  });\n};\n"],"file":"ajax.js"}