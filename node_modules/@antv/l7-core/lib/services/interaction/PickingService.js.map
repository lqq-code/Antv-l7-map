{"version":3,"sources":["../../../src/services/interaction/PickingService.ts"],"names":["PickingService","TYPES","IMapService","IRendererService","IGlobalConfigService","IInteractionService","ILayerService","layer","x","y","lngLat","type","target","isPicked","rendererService","getViewportSize","readPixels","getContainer","getContainerSize","width","height","DOM","DPR","getLayerConfig","enableHighlight","enableSelect","xInDevicePixel","yInDevicePixel","pickedColors","Math","floor","pickBufferScale","data","Uint8Array","framebuffer","pickingFBO","pickedFeatureIdx","rawFeature","getSource","getFeatureById","getCurrentPickId","layerTarget","featureId","feature","setCurrentPickId","pickedLayers","triggerHoverOnLayer","highlightPickedFeature","toString","selectedId","getCurrentSelectedId","selectFeature","setCurrentSelectedId","isVector","layerService","getLayers","filter","l","tileLayer","map","clearPickState","id","createTexture2D","createFramebuffer","configService","getSceneConfig","color","round","wrapS","gl","CLAMP_TO_EDGE","wrapT","interactionService","on","InteractionEvent","Hover","pickingAllLayer","bind","box","cb","useFramebuffer","clear","resizePickingFBO","stencil","depth","hooks","beforePickingEncode","call","renderModels","afterPickingEncode","features","pickBox","v","tmpV","xMin","yMin","xMax","yMax","w","min","h","featuresIdMap","i","length","slice","push","cursor","cursorEnabled","version","mapService","domContainer","getMapContainer","getMarkerContainer","defaultCursor","style","getPropertyValue","setProperty","destroy","container","getContext","getBoundingClientRect","alreadyInPicking","alreadyInRendering","indragging","getShaderPickStat","pickingLayers","renderLayers","resize","layers","getRenderList","needPick","reverse","some","pickedlayer","pickedTileLayers","pickedTileLayer","clearPick","pickLayers","masks","m","beforeRenderData","beforeRender","render","afterRender","pickFromPickingFBO","pickedLayerId","enablePropagation","handleCursor","emit","r","g","b","beforeHighlight","beforeSelect"],"mappings":"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","sourcesContent":["import {\n  decodePickingColor,\n  DOM,\n  encodePickingColor,\n  isMini,\n} from '@antv/l7-utils';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { isEventCrash } from '../../utils/dom';\nimport { IGlobalConfigService, ISceneConfig } from '../config/IConfigService';\nimport {\n  IInteractionService,\n  IInteractionTarget,\n  InteractionEvent,\n} from '../interaction/IInteractionService';\nimport { ILayer, ILayerService } from '../layer/ILayerService';\nimport { ILngLat, IMapService } from '../map/IMapService';\nimport { gl } from '../renderer/gl';\nimport { IFramebuffer } from '../renderer/IFramebuffer';\nimport { IRendererService } from '../renderer/IRendererService';\nimport { IPickingService } from './IPickingService';\n@injectable()\nexport default class PickingService implements IPickingService {\n  public pickedColors: Uint8Array | undefined;\n  public pickedTileLayers: ILayer[] = [];\n  @inject(TYPES.IMapService)\n  private readonly mapService: IMapService;\n\n  @inject(TYPES.IRendererService)\n  private rendererService: IRendererService;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.IInteractionService)\n  private interactionService: IInteractionService;\n\n  @inject(TYPES.ILayerService)\n  private layerService: ILayerService;\n  private pickingFBO: IFramebuffer;\n\n  private width: number = 0;\n\n  private height: number = 0;\n\n  private alreadyInPicking: boolean = false;\n\n  private pickBufferScale: number = 1.0;\n\n  // Tip: 记录当前拾取中的 layers\n  private pickedLayers: ILayer[] = [];\n\n  public init(id: string) {\n    const {\n      createTexture2D,\n      createFramebuffer,\n      getViewportSize,\n      getContainer,\n    } = this.rendererService;\n\n    let { width, height } = this.getContainerSize(\n      getContainer() as HTMLCanvasElement | HTMLElement,\n    );\n    width *= DOM.DPR;\n    height *= DOM.DPR;\n    this.pickBufferScale =\n      this.configService.getSceneConfig(id).pickBufferScale || 1;\n    // 创建 picking framebuffer，后续实时 resize\n    this.pickingFBO = createFramebuffer({\n      color: createTexture2D({\n        width: Math.round(width / this.pickBufferScale),\n        height: Math.round(height / this.pickBufferScale),\n        wrapS: gl.CLAMP_TO_EDGE,\n        wrapT: gl.CLAMP_TO_EDGE,\n      }),\n    });\n\n    // 监听 hover 事件\n    this.interactionService.on(\n      InteractionEvent.Hover,\n      this.pickingAllLayer.bind(this),\n    );\n  }\n\n  public async boxPickLayer(\n    layer: ILayer,\n    box: [number, number, number, number],\n    cb: (...args: any[]) => void,\n  ): Promise<any> {\n    const { useFramebuffer, clear, getContainer } = this.rendererService;\n    this.resizePickingFBO();\n    useFramebuffer(this.pickingFBO, () => {\n      clear({\n        framebuffer: this.pickingFBO,\n        color: [0, 0, 0, 0],\n        stencil: 0,\n        depth: 1,\n      });\n      layer.hooks.beforePickingEncode.call();\n      layer.renderModels();\n      layer.hooks.afterPickingEncode.call();\n      const features = this.pickBox(layer, box);\n      cb(features);\n    });\n  }\n\n  public pickBox(layer: ILayer, box: [number, number, number, number]): any[] {\n    const [xMin, yMin, xMax, yMax] = box.map((v) => {\n      const tmpV = v < 0 ? 0 : v;\n      return Math.floor((tmpV * DOM.DPR) / this.pickBufferScale);\n    });\n    const { getViewportSize, readPixels, getContainer } = this.rendererService;\n    let { width, height } = this.getContainerSize(\n      getContainer() as HTMLCanvasElement | HTMLElement,\n    );\n    width *= DOM.DPR;\n    height *= DOM.DPR;\n    if (\n      xMin > ((width - 1) * DOM.DPR) / this.pickBufferScale ||\n      xMax < 0 ||\n      yMin > ((height - 1) * DOM.DPR) / this.pickBufferScale ||\n      yMax < 0\n    ) {\n      return [];\n    }\n    let pickedColors: Uint8Array | undefined;\n    const w = Math.min(width / this.pickBufferScale, xMax) - xMin;\n    const h = Math.min(height / this.pickBufferScale, yMax) - yMin;\n    pickedColors = readPixels({\n      x: xMin,\n      // 视口坐标系原点在左上，而 WebGL 在左下，需要翻转 Y 轴\n      y: Math.floor(height / this.pickBufferScale - (yMax + 1)),\n      width: w,\n      height: h,\n      data: new Uint8Array(w * h * 4),\n      framebuffer: this.pickingFBO,\n    });\n\n    const features = [];\n    const featuresIdMap: { [key: string]: boolean } = {};\n    for (let i = 0; i < pickedColors.length / 4; i = i + 1) {\n      const color = pickedColors.slice(i * 4, i * 4 + 4);\n      const pickedFeatureIdx = decodePickingColor(color);\n      if (pickedFeatureIdx !== -1 && !featuresIdMap[pickedFeatureIdx]) {\n        const rawFeature = layer.getSource().getFeatureById(pickedFeatureIdx);\n        features.push({\n          // @ts-ignore\n          ...rawFeature,\n          pickedFeatureIdx,\n        });\n        featuresIdMap[pickedFeatureIdx] = true;\n      }\n    }\n    return features;\n  }\n\n  // 动态设置鼠标光标\n  public handleCursor(layer: ILayer, type: string) {\n    const { cursor = '', cursorEnabled } = layer.getLayerConfig();\n    if (cursorEnabled) {\n      const version = this.mapService.version;\n      const domContainer =\n        version === 'GAODE2.x'\n          ? this.mapService.getMapContainer()\n          : this.mapService.getMarkerContainer();\n      // const domContainer = this.mapService.getMarkerContainer();\n      // const domContainer = this.mapService.getMapContainer();\n      const defaultCursor = domContainer?.style.getPropertyValue('cursor');\n      if (type === 'unmousemove' && defaultCursor !== '') {\n        domContainer?.style.setProperty('cursor', '');\n      } else if (type === 'mousemove') {\n        domContainer?.style.setProperty('cursor', cursor);\n      }\n    }\n    // const domContainer = this.mapService.getMapContainer()\n    // domContainer?.style.setProperty('cursor', 'move');\n  }\n\n  public destroy() {\n    this.pickingFBO.destroy();\n    // this.pickingFBO = null; 清除对 webgl 实例的引用\n    // @ts-ignore\n    this.pickingFBO = null;\n  }\n\n  public pickFromPickingFBO = (\n    layer: ILayer,\n    { x, y, lngLat, type, target }: IInteractionTarget,\n  ) => {\n    let isPicked = false;\n    const { getViewportSize, readPixels, getContainer } = this.rendererService;\n    let { width, height } = this.getContainerSize(\n      getContainer() as HTMLCanvasElement | HTMLElement,\n    );\n    width *= DOM.DPR;\n    height *= DOM.DPR;\n\n    const { enableHighlight, enableSelect } = layer.getLayerConfig();\n\n    const xInDevicePixel = x * DOM.DPR;\n    const yInDevicePixel = y * DOM.DPR;\n    if (\n      xInDevicePixel > width - 1 * DOM.DPR ||\n      xInDevicePixel < 0 ||\n      yInDevicePixel > height - 1 * DOM.DPR ||\n      yInDevicePixel < 0\n    ) {\n      return false;\n    }\n    let pickedColors: Uint8Array | undefined;\n    pickedColors = readPixels({\n      x: Math.floor(xInDevicePixel / this.pickBufferScale),\n      // 视口坐标系原点在左上，而 WebGL 在左下，需要翻转 Y 轴\n      y: Math.floor((height - (y + 1) * DOM.DPR) / this.pickBufferScale),\n      width: 1,\n      height: 1,\n      data: new Uint8Array(1 * 1 * 4),\n      framebuffer: this.pickingFBO,\n    });\n    this.pickedColors = pickedColors;\n\n    // let pickedColors = new Uint8Array(4)\n    // this.rendererService.getGLContext().readPixels(\n    //   Math.floor(xInDevicePixel / this.pickBufferScale),\n    //   Math.floor((height - (y + 1) * DOM.DPR) / this.pickBufferScale),\n    //   1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pickedColors)\n    // console.log(pickedColors[0] == pixels[0] && pickedColors[1] == pixels[1] && pickedColors[2] == pixels[2])\n\n    if (\n      pickedColors[0] !== 0 ||\n      pickedColors[1] !== 0 ||\n      pickedColors[2] !== 0\n    ) {\n      const pickedFeatureIdx = decodePickingColor(pickedColors);\n      const rawFeature = layer.getSource().getFeatureById(pickedFeatureIdx);\n      if (\n        pickedFeatureIdx !== layer.getCurrentPickId() &&\n        type === 'mousemove'\n      ) {\n        type = 'mouseenter';\n      }\n\n      const layerTarget = {\n        x,\n        y,\n        type,\n        lngLat,\n        featureId: pickedFeatureIdx,\n        feature: rawFeature,\n        target,\n      };\n      if (!rawFeature) {\n        // this.logger.error(\n        //   '未找到颜色编码解码后的原始 feature，请检查 fragment shader 中末尾是否添加了 `gl_FragColor = filterColor(gl_FragColor);`',\n        // );\n      } else {\n        // trigger onHover/Click callback on layer\n        isPicked = true;\n        layer.setCurrentPickId(pickedFeatureIdx);\n        this.pickedLayers = [layer];\n        this.triggerHoverOnLayer(layer, layerTarget); // 触发拾取事件\n      }\n    } else {\n      // 未选中\n      const layerTarget = {\n        x,\n        y,\n        lngLat,\n        type:\n          layer.getCurrentPickId() !== null && type === 'mousemove'\n            ? 'mouseout'\n            : 'un' + type,\n        featureId: null,\n        target,\n        feature: null,\n      };\n      this.triggerHoverOnLayer(layer, {\n        ...layerTarget,\n        type: 'unpick',\n      });\n      this.triggerHoverOnLayer(layer, layerTarget);\n      layer.setCurrentPickId(null);\n      this.pickedLayers = [];\n    }\n\n    if (enableHighlight) {\n      this.highlightPickedFeature(layer, pickedColors);\n    }\n    if (\n      enableSelect &&\n      type === 'click' &&\n      pickedColors?.toString() !== [0, 0, 0, 0].toString()\n    ) {\n      const selectedId = decodePickingColor(pickedColors);\n      if (\n        layer.getCurrentSelectedId() === null ||\n        selectedId !== layer.getCurrentSelectedId()\n      ) {\n        this.selectFeature(layer, pickedColors);\n        layer.setCurrentSelectedId(selectedId);\n      } else {\n        this.selectFeature(layer, new Uint8Array([0, 0, 0, 0])); // toggle select\n        layer.setCurrentSelectedId(null);\n      }\n      if (!layer.isVector) {\n        // Tip: 选中普通 layer 的时候将 tileLayer 的选中状态清除\n        this.layerService\n          .getLayers()\n          .filter((l) => l.tileLayer)\n          .map((l) => {\n            l.tileLayer.clearPickState();\n          });\n      }\n    }\n    return isPicked;\n  };\n\n  // 获取容器的大小 - 兼容小程序环境\n  private getContainerSize(container: HTMLCanvasElement | HTMLElement) {\n    if (!!(container as HTMLCanvasElement).getContext) {\n      return {\n        width: (container as HTMLCanvasElement).width / DOM.DPR,\n        height: (container as HTMLCanvasElement).height / DOM.DPR,\n      };\n    } else {\n      return container.getBoundingClientRect();\n    }\n  }\n  private async pickingAllLayer(target: IInteractionTarget) {\n    if (\n      // TODO: this.alreadyInPicking 避免多次重复拾取\n      this.alreadyInPicking ||\n      // TODO: this.layerService.alreadyInRendering 一个渲染序列中只进行一次拾取操作\n      this.layerService.alreadyInRendering ||\n      // Tip: this.interactionService.dragging amap2 在点击操作的时候同时会触发 dragging 的情况（避免舍去）\n      this.interactionService.indragging ||\n      // TODO: 判断当前 是都进行 shader pick 拾取判断\n      !this.layerService.getShaderPickStat()\n    ) {\n      return;\n    }\n    this.alreadyInPicking = true;\n    await this.pickingLayers(target);\n    this.layerService.renderLayers();\n    this.alreadyInPicking = false;\n  }\n\n  private resizePickingFBO() {\n    const { getContainer } = this.rendererService;\n    let { width, height } = this.getContainerSize(\n      getContainer() as HTMLCanvasElement | HTMLElement,\n    );\n    width *= DOM.DPR;\n    height *= DOM.DPR;\n\n    if (this.width !== width || this.height !== height) {\n      this.pickingFBO.resize({\n        width: Math.round(width / this.pickBufferScale),\n        height: Math.round(height / this.pickBufferScale),\n      });\n      this.width = width;\n      this.height = height;\n    }\n  }\n  private async pickingLayers(target: IInteractionTarget) {\n    const {\n      getViewportSize,\n      useFramebuffer,\n      clear,\n      getContainer,\n    } = this.rendererService;\n    this.resizePickingFBO();\n\n    useFramebuffer(this.pickingFBO, () => {\n      const layers = this.layerService.getRenderList();\n      layers\n        .filter((layer) => layer.needPick(target.type))\n        .reverse()\n        .some((layer) => {\n          clear({\n            framebuffer: this.pickingFBO,\n            color: [0, 0, 0, 0],\n            stencil: 0,\n            depth: 1,\n          });\n\n          // Tip: clear last picked layer state\n          this.pickedLayers\n            .filter((pickedlayer) => !pickedlayer.isVector)\n            .map((pickedlayer) => {\n              this.selectFeature(pickedlayer, new Uint8Array([0, 0, 0, 0]));\n            });\n          // Tip: clear last picked tilelayer state\n          this.pickedTileLayers.map((pickedTileLayer) =>\n            pickedTileLayer.tileLayer?.clearPick(target.type),\n          );\n\n          // Tip: 如果当前 layer 是瓦片图层，则走瓦片图层独立的拾取逻辑\n          if (layer.tileLayer) {\n            return layer.tileLayer.pickLayers(target);\n          }\n\n          layer.hooks.beforePickingEncode.call();\n\n          if (layer.masks.length > 0) {\n            // 若存在 mask，则在 pick 阶段的绘制也启用\n            layer.masks.map((m: ILayer) => {\n              m.hooks.beforeRenderData.call();\n              m.hooks.beforeRender.call();\n              m.render();\n              m.hooks.afterRender.call();\n            });\n          }\n          layer.renderModels(true);\n          layer.hooks.afterPickingEncode.call();\n\n          const isPicked = this.pickFromPickingFBO(layer, target);\n\n          this.layerService.pickedLayerId = isPicked ? +layer.id : -1;\n          return isPicked && !layer.getLayerConfig().enablePropagation;\n        });\n    });\n  }\n  private triggerHoverOnLayer(\n    layer: ILayer,\n    target: {\n      x: number;\n      y: number;\n      type: string;\n      lngLat: ILngLat;\n      feature: unknown;\n      featureId: number | null;\n    },\n  ) {\n    // layer.emit(target.type, target);\n    // 判断是否发生事件冲突\n    if (isEventCrash(target)) {\n      // Tip: 允许用户动态设置鼠标光标\n      this.handleCursor(layer, target.type);\n      layer.emit(target.type, target);\n    }\n  }\n\n  /**\n   * highlight 如果直接修改选中 feature 的 buffer，存在两个问题：\n   * 1. 鼠标移走时无法恢复\n   * 2. 无法实现高亮颜色与原始原色的 alpha 混合\n   * 因此高亮还是放在 shader 中做比较好\n   * @example\n   * this.layer.color('name', ['#000000'], {\n   *  featureRange: {\n   *    startIndex: pickedFeatureIdx,\n   *    endIndex: pickedFeatureIdx + 1,\n   *  },\n   * });\n   */\n  private highlightPickedFeature(\n    layer: ILayer,\n    pickedColors: Uint8Array | undefined,\n  ) {\n    // @ts-ignore\n    const [r, g, b] = pickedColors;\n    layer.hooks.beforeHighlight.call([r, g, b]);\n  }\n\n  private selectFeature(layer: ILayer, pickedColors: Uint8Array | undefined) {\n    // @ts-ignore\n    const [r, g, b] = pickedColors;\n    layer.hooks.beforeSelect.call([r, g, b]);\n  }\n}\n"],"file":"PickingService.js"}